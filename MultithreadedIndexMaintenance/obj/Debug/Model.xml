<?xml version="1.0" encoding="utf-8"?>
<DataSchemaModel FileFormatVersion="1.2" SchemaVersion="2.9" DspName="Microsoft.Data.Tools.Schema.Sql.Sql130DatabaseSchemaProvider" CollationLcid="1033" CollationCaseSensitive="False" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
	<Header>
		<CustomData Category="AnsiNulls">
			<Metadata Name="AnsiNulls" Value="True" />
		</CustomData>
		<CustomData Category="QuotedIdentifier">
			<Metadata Name="QuotedIdentifier" Value="True" />
		</CustomData>
		<CustomData Category="CompatibilityMode">
			<Metadata Name="CompatibilityMode" Value="130" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO 14.0\COMMON7\IDE\EXTENSIONS\MICROSOFT\SQLDB\EXTENSIONS\SQLSERVER\130\SQLSCHEMAS\MSDB.DACPAC" />
			<Metadata Name="LogicalName" Value="msdb.dacpac" />
			<Metadata Name="ExternalParts" Value="[msdb]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO 14.0\COMMON7\IDE\EXTENSIONS\MICROSOFT\SQLDB\EXTENSIONS\SQLSERVER\130\SQLSCHEMAS\MASTER.DACPAC" />
			<Metadata Name="LogicalName" Value="master.dacpac" />
			<Metadata Name="ExternalParts" Value="[master]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="MultithreadedIndexMaintenance.dll" />
			<Metadata Name="FileName" Value="D:\SOURCE\REPOS\MULTITHREADEDINDEXMAINTENANCE\MULTITHREADEDINDEXMAINTENANCE\OBJ\DEBUG\MULTITHREADEDINDEXMAINTENANCE.DLL" />
			<Metadata Name="AssemblyName" Value="MultithreadedIndexMaintenance" />
			<Metadata Name="PermissionSet" Value="SAFE" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="True" />
			<Metadata Name="AssemblySymbolsName" Value="D:\Source\Repos\MultithreadedIndexMaintenance\MultithreadedIndexMaintenance\obj\Debug\MultithreadedIndexMaintenance.pdb" />
		</CustomData>
		<CustomData Category="SqlCmdVariables" Type="SqlCmdVariable" />
	</Header>
	<Model>
		<Element Type="SqlDatabaseOptions">
			<Property Name="Collation" Value="SQL_Latin1_General_CP1_CI_AS" />
			<Property Name="IsAnsiNullDefaultOn" Value="True" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Property Name="IsAnsiWarningsOn" Value="True" />
			<Property Name="IsArithAbortOn" Value="True" />
			<Property Name="IsConcatNullYieldsNullOn" Value="True" />
			<Property Name="IsTornPageProtectionOn" Value="False" />
			<Property Name="IsFullTextEnabled" Value="True" />
			<Property Name="PageVerifyMode" Value="3" />
			<Property Name="DefaultLanguage" Value="" />
			<Property Name="DefaultFullTextLanguage" Value="" />
			<Property Name="QueryStoreStaleQueryThreshold" Value="367" />
			<Relationship Name="DefaultFilegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[GetDate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateAdded]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="12" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA['1']]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="13" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[MaintenanceWindow].[Id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[MaintenanceWindow]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="14" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[FragmentedIndexes]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[Id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[DateAdded]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="12" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[DateStarted]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[DateCompleted]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[DBName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[SchemaName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[TableName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[IndexName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[FragmentationPercent]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="15" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[IndexID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[PageCount]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[RunnerID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[StatusID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="13" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentedIndexes].[CustomOrder]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="15" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[MaintenanceWindow]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[MaintenanceWindow].[Id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="14" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[MaintenanceWindow].[MaintDay]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[MaintenanceWindow].[StartTime]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="7" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[time]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[MaintenanceWindow].[EndTime]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="7" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[time]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_FragmentedIndexes_ID]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentedIndexes].[Id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="15" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_Runners_RunnerID]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Runners].[RunnerID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Runners]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="16" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_Statuses_StatusID]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Statuses].[StatusID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Statuses]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="17" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Runners]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Runners].[RunnerID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Runners].[JobName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Runners].[JobID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Runners].[ScheduleID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Runners].[CreateDate]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="16" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Statuses]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Statuses].[StatusID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Statuses].[StatusDesc]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="17" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[usp_CreateNewRunnerWithWatcher]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN

	Declare @RunnerID int
		, @GUID uniqueidentifier
		, @JobName nvarchar(128)
		, @jobId BINARY(16)
		, @schedule_id int
		, @ScheduleName nvarchar(128)
		, @DefragCmd nvarchar(256)
		, @DBName nvarchar(256) = DB_Name()

	Select  @GUID = NEWID()
		, @JobName = 'IxMaint_' + cast(@GUID as nvarchar(128))
		, @ScheduleName = @JobName + '_Sched'
	
	--Select @JobName
	
	-- Create Runner Job
	EXEC  msdb.dbo.sp_add_job @job_name=@JobName,
			@enabled=1, 
			@notify_level_eventlog=0, 
			@notify_level_email=2, 
			@notify_level_page=2, 
			@delete_level=0, 
			@category_name=N'Database Maintenance', 
			@owner_login_name=N'sa', @job_id = @jobId OUTPUT
	--select @jobId
	--GO
	EXEC msdb.dbo.sp_add_jobserver @job_name=@JobName
	--GO
	--USE [msdb]
	--GO
	EXEC msdb.dbo.sp_add_jobstep @job_name=@JobName, @step_name=N'RunIndexMaint', 
			@step_id=1, 
			@cmdexec_success_code=0, 
			@on_success_action=1, 
			@on_fail_action=2, 
			@retry_attempts=0, 
			@retry_interval=0, 
			@os_run_priority=0, @subsystem=N'TSQL', 
			@command=N'-- Exec dbo.usp_DefragIndexes', 
			@database_name=@DBName, 
			@flags=0
	--GO
	--USE [msdb]
	--GO
	EXEC msdb.dbo.sp_update_job @job_name=@JobName, 
			@enabled=1, 
			@start_step_id=1, 
			@notify_level_eventlog=0, 
			@notify_level_email=2, 
			@notify_level_page=2, 
			@delete_level=0, 
			@description=N'', 
			@category_name=N'Database Maintenance', 
			@owner_login_name=N'sa', 
			@notify_email_operator_name=N'', 
			@notify_page_operator_name=N''
	--GO
	--USE [msdb]
	--GO
	--DECLARE 
	EXEC msdb.dbo.sp_add_jobschedule @job_name=@JobName, @name=@ScheduleName, 
			@enabled=1, 
			@freq_type=8, 
			@freq_interval=64, 
			@freq_subday_type=1, 
			@freq_subday_interval=0, 
			@freq_relative_interval=0, 
			@freq_recurrence_factor=1, 
			@active_start_date=20181228, 
			@active_end_date=99991231, 
			@active_start_time=10000, 
			@active_end_time=235959, @schedule_id = @schedule_id OUTPUT
	--select @schedule_id
	--GO

	Insert Into dbo.Runners (JobName, JobID, ScheduleID, CreateDate)
		Select @JobName, @jobId, @schedule_id, GetDate()
	
	Select @RunnerID = RunnerID
		, @DefragCmd = N'Exec dbo.usp_DefragIndexes @RunnerID = ' + cast(RunnerID as nvarchar(10))
		From dbo.Runners
		Where JobName = @JobName

	EXEC msdb.dbo.sp_update_jobstep @job_name=@JobName,
			@step_id=1, 
			@command=@DefragCmd

	Exec dbo.usp_CreateWatcherJob
		@JobNameToWatch = @JobName
		--@RunnerID = @RunnerID, @WatchJobName = @JobName

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[binary]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_eventlog]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_email]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_page]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@delete_level]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@category_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@owner_login_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@step_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@cmdexec_success_code]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_success_action]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_fail_action]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@retry_attempts]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@retry_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@os_run_priority]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@subsystem]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@command]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@database_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@flags]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@start_step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_level_eventlog]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_level_email]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_level_page]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@delete_level]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@description]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@category_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@owner_login_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_email_operator_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_page_operator_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_subday_type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_subday_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_relative_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_recurrence_factor]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_start_date]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_end_date]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_start_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_end_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@schedule_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[JobName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[JobID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[ScheduleID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[CreateDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[RunnerID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_jobstep]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_jobstep].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_jobstep].[@step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_jobstep].[@command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[usp_CreateWatcherJob]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[usp_CreateWatcherJob].[@JobNameToWatch]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2621" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[usp_CreateNewRunnerWithWatcher]&#xD;&#xA;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[usp_CreateWatcherJob]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN

	Declare
		@WatcherJobName nvarchar(128)
		, @WatcherScheduleName nvarchar(128)
		, @jobId BINARY(16)
		, @schedule_id int
		, @ScheduleName nvarchar(128)
		, @WatcherJobStepCommand nvarchar(512)
		, @DBName nvarchar(256) = DB_Name()

	Select @WatcherJobName = @JobNameToWatch + '_Watcher'
		, @WatcherScheduleName = @WatcherJobName + '_Sched'
		, @WatcherJobStepCommand = N'Exec dbo.usp_WatchJob @JobNameToWatch = ''' + cast(@JobNameToWatch as nvarchar(128)) + ''''

	-- Create Watcher Job
	EXEC  msdb.dbo.sp_add_job @job_name=@WatcherJobName,
			@enabled=1, 
			@notify_level_eventlog=0, 
			@notify_level_email=2, 
			@notify_level_page=2, 
			@delete_level=0, 
			@category_name=N'Database Maintenance', 
			@owner_login_name=N'sa', @job_id = @jobId OUTPUT
	--select @jobId
	--GO
	EXEC msdb.dbo.sp_add_jobserver @job_name=@WatcherJobName
	--GO
	--USE [msdb]
	--GO
	EXEC msdb.dbo.sp_add_jobstep @job_name=@WatcherJobName, @step_name=N'WatchIndexMaint', 
			@step_id=1, 
			@cmdexec_success_code=0, 
			@on_success_action=1, 
			@on_fail_action=2, 
			@retry_attempts=0, 
			@retry_interval=0, 
			@os_run_priority=0, @subsystem=N'TSQL', 
			@command=@WatcherJobStepCommand, 
			@database_name=@DBName, 
			@flags=0
	--GO
	--USE [msdb]
	--GO
	EXEC msdb.dbo.sp_update_job @job_name=@WatcherJobName, 
			@enabled=1, 
			@start_step_id=1, 
			@notify_level_eventlog=0, 
			@notify_level_email=2, 
			@notify_level_page=2, 
			@delete_level=0, 
			@description=N'', 
			@category_name=N'Database Maintenance', 
			@owner_login_name=N'sa', 
			@notify_email_operator_name=N'', 
			@notify_page_operator_name=N''
	--GO
	--USE [msdb]
	--GO
	--DECLARE 
	EXEC msdb.dbo.sp_add_jobschedule @job_name=@WatcherJobName, @name=@WatcherScheduleName, 
			@enabled=1, 
			@freq_type=8, 
			@freq_interval=64, 
			@freq_subday_type=4, 
			@freq_subday_interval=1, 
			@freq_relative_interval=0, 
			@freq_recurrence_factor=1, 
			@active_start_date=20181228, 
			@active_end_date=99991231, 
			@active_start_time=10000, 
			@active_end_time=60001, @schedule_id = @schedule_id OUTPUT
	--select @schedule_id
	--GO


END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[binary]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[usp_CreateWatcherJob].[@JobNameToWatch]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_eventlog]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_email]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_page]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@delete_level]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@category_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@owner_login_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@step_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@cmdexec_success_code]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_success_action]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_fail_action]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@retry_attempts]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@retry_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@os_run_priority]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@subsystem]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@command]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@database_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@flags]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@start_step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_level_eventlog]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_level_email]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_level_page]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@delete_level]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@description]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@category_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@owner_login_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_email_operator_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@notify_page_operator_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_subday_type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_subday_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_relative_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_recurrence_factor]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_start_date]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_end_date]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_start_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_end_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@schedule_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[usp_CreateWatcherJob].[@JobNameToWatch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2270" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[usp_CreateWatcherJob]&#xD;&#xA;&#x9;@JobNameToWatch nvarchar(128)&#xD;&#xA;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[usp_DefragIndexes]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN

	SET NOCOUNT ON

	Declare @SqlCmd nvarchar(max)
		, @IxID int
		, @MaintDay varchar(10)
		, @MaintWindowStart time
		, @MaintWindowEnd time

	Select 
		@MaintDay = MaintDay
		, @MaintWindowStart = StartTime
		, @MaintWindowEnd = EndTime
	from dbo.MaintenanceWindow

	WHILE ( (exists (select top 1 1 from dbo.FragmentedIndexes where RunnerID = @RunnerID and StatusID = 1 and DateCompleted is null)) 
		and (cast(GetDate() as Time) between @MaintWindowStart and @MaintWindowEnd) )
	BEGIN
		-- get index to rebuild
		SELECT TOP 1 
			@IxID = [Id]
			--,[DateAdded]
			, @SqlCmd = 'use ' + quotename(DBName) + ' -- Alter Index ' +quotename(IndexName)+ ' on ' +quotename(SchemaName)+ '.' + quotename(TableName)+ ' REBUILD WITH (ONLINE = ON)'
		FROM dbo.FragmentedIndexes
		WHERE RunnerID = @RunnerID
			AND StatusID = 1
			AND DateCompleted is null
		ORDER BY CustomOrder ASC

		Update dbo.FragmentedIndexes
			set StatusID = 2
				, DateStarted = GetDate()
			where ID = @IxID
		
		Begin Try
			Print @SqlCmd
		
			Update dbo.FragmentedIndexes
				set StatusID = 3
					, DateCompleted = GetDate()
				where ID = @IxID
		End Try
		Begin Catch
			Update dbo.FragmentedIndexes
				set StatusID = 4
					, DateCompleted = GetDate()
				where ID = @IxID
		End Catch
	
	END
	
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow].[MaintDay]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow].[StartTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[usp_DefragIndexes].[@RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateCompleted]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[Id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DBName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[IndexName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[SchemaName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[TableName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateCompleted]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[CustomOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateStarted]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[usp_DefragIndexes].[@RunnerID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1398" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[usp_DefragIndexes]&#xD;&#xA;&#x9;@RunnerID int&#xD;&#xA;&#x9;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[usp_GetFragmentedIndexes]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN
	--Select [DBName], [SchemaName], [TableName], [IndexName], [IndexID] , [RunnerID], [StatusID], [CustomOrder] 
	Declare @SqlCmd nvarchar(max)

	-- Get all fragmented indexes on the instance to be rebuilt
	set @SqlCmd = '
	exec sp_MSforeachdb ''
		use [?]
		declare @dbid int
		
		select @dbid = database_id
		from sys.databases
		where name = DB_NAME()

		SELECT 
			''''?'''' as dbname,
			OBJECT_SCHEMA_NAME(ps.object_id),
			OBJECT_NAME(ps.object_id)
			, i.name
			, ps.avg_fragmentation_in_percent
			, i.index_id
			, ps.page_count
		from sys.dm_db_index_physical_stats(@dbid,null,null,null,null) as ps
			join sys.indexes as i
				on ps.object_id = i.object_id AND ps.index_id = i.index_id
		where avg_fragmentation_in_percent > 30 and page_count > 100 and ps.index_id > 0
		order by ps.index_id, ps.object_id
	''
'



	Insert Into dbo.FragmentedIndexes ([DBName], [SchemaName], [TableName], [IndexName], [FragmentationPercent], [IndexID], [PageCount])
		Exec (@SqlCmd)



END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DBName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[SchemaName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[TableName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[IndexName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[FragmentationPercent]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[IndexID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[PageCount]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1085" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[usp_GetFragmentedIndexes]&#xD;&#xA;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[usp_SortFragmentedIndexes]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN

	-- set the custom sort order & RunnerID & set all indexes to "New" entries

	Declare @RunnerCount int
	Select @RunnerCount = 
		case Count(RunnerID) 
			when 0 then 1
			else Count(RunnerID)
			end
		from dbo.Runners

	update
		i
	set
		i.CustomOrder = b.RowNum,
		i.RunnerID = (b.RowNum % @RunnerCount)+1,
		i.StatusID = 1
	From
		dbo.FragmentedIndexes as i
		inner join (
			select Id, StatusID, IndexID, PageCount
				, ROW_NUMBER() OVER(partition by StatusID order by case when IndexID > 1 then 2 else 1 end, PageCount desc) as RowNum
				from dbo.FragmentedIndexes
				where DateCompleted is null) as b 
					on b.Id = i.Id


END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[Id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[IndexID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[PageCount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateCompleted]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[Id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[Id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[CustomOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="730" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[usp_SortFragmentedIndexes]&#xD;&#xA;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[usp_WatchJob]">
			<Property Name="BodyScript">
				<Value><![CDATA[

BEGIN
	-- Watcher job runs every 1 minute between 0100 and 0600 on saturday morning (maintenance window) calling this procedure

	-- Watcher will kill the job if:
		-- job is still running after maintenance window end
		-- rebuild has been running for longer than @KillThreshold (default 900 seconds = 15 minutes)
			-- in this circumstance, if we are still in the maintenance window, the watcher will kick off the job again

	Declare @SqlCmd nvarchar(max)
		, @IxID int
		, @MaintDay varchar(10)
		, @MaintWindowStart time
		, @MaintWindowEnd time
		, @JobID uniqueidentifier
		, @RunnerID int
		, @program_name nvarchar(256) 

	Select @JobID = JobID
		, @RunnerID = RunnerID
		, @program_name = N'SQLAgent - TSQL JobStep (Job ' +  convert(varchar(128), cast(@JobID as varbinary(128)), 1) + N' : Step 1)'
		from dbo.Runners
		where JobName = @JobNameToWatch

	Select 
		@MaintDay = MaintDay
		, @MaintWindowStart = StartTime
		, @MaintWindowEnd = EndTime
	from dbo.MaintenanceWindow

	-- if the job is running
	IF ( exists (Select top 1 session_id from sys.dm_exec_sessions where program_name = @program_name) )
	BEGIN
		-- if we are outside the maintenance window, stop the job & mark the index it was rebuilding as "in error"
		IF ( cast(GetDate() as Time) > @MaintWindowEnd )
		BEGIN
			
			Exec msdb.dbo.sp_stop_job @job_name = @JobNameToWatch
			
			Update dbo.FragmentedIndexes
				set StatusID = 4
					, DateCompleted = GetDate()
				where RunnerID = @RunnerID
					and StatusID = 2
					and DateCompleted is null
		END
		-- if the job has been rebuilding the same index for more than @KillThreshold seconds, stop the job, mark the index it was rebuilding as "in error", and restart the job
		ELSE IF ( (Select datediff(second,[DateStarted],GetDate()) from dbo.FragmentedIndexes where RunnerID = @RunnerID and StatusID = 2 and DateCompleted is null) > @JobRunDurationKillThreshold_Seconds )
		BEGIN
			Exec msdb.dbo.sp_stop_job @job_name = @JobNameToWatch
		
			Update dbo.FragmentedIndexes
				set StatusID = 4
					, DateCompleted = GetDate()
				where RunnerID = @RunnerID
					and StatusID = 2
					and DateCompleted is null

			IF ( cast(GetDate() as Time) between @MaintWindowStart and @MaintWindowEnd )
			BEGIN
				EXEC msdb.dbo.sp_start_job  @job_name = @JobNameToWatch
			END
		END
	END
	-- if the job IS NOT running but there ARE indexes to process AND we are still in the maintenance window, start the job
	ELSE IF ( (Exists (Select top 1 1 from dbo.FragmentedIndexes where RunnerID = @RunnerID and StatusID = 1 and DateCompleted is null))
		AND (cast(GetDate() as Time) between @MaintWindowStart and @MaintWindowEnd) )
	BEGIN
		EXEC msdb.dbo.sp_start_job  @job_name = @JobNameToWatch
	END

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[JobID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[RunnerID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Runners].[JobName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[usp_WatchJob].[@JobNameToWatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow].[MaintDay]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow].[StartTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[MaintenanceWindow].[EndTime]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[session_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[program_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_stop_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_stop_job].[@job_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateCompleted]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateStarted]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[RunnerID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentedIndexes].[DateCompleted]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[usp_WatchJob].[@JobRunDurationKillThreshold_Seconds]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_start_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_start_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[time]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[usp_WatchJob].[@JobNameToWatch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[usp_WatchJob].[@JobRunDurationKillThreshold_Seconds]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[900]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2913" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[usp_WatchJob]&#xD;&#xA;&#x9;@JobNameToWatch nvarchar(128)&#xD;&#xA;&#x9;, @JobRunDurationKillThreshold_Seconds int = 900&#xD;&#xA;AS" />
			</Annotation>
		</Element>
	</Model>
</DataSchemaModel>